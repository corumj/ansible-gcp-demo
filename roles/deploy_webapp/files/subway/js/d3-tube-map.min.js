// https://github.com/johnwalley/d3-tube-map/ v1.2.2 Copyright 2020 John Walley
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],e):e((t=t||self).d3=t.d3||{},t.d3)}(this,(function(t,e){"use strict";function r(t,e,r,n,a){for(var o,s,i,l,c,d="",h=t.nodes,f=Math.abs(e(1)-e(0)!=0?e(1)-e(0):r(1)-r(0)),u=Math.sqrt(2),p=[t.shiftCoords[0]*n/f,t.shiftCoords[1]*n/f],b="diagonal",m=0;m<h.length;m++)if(m>0){o=h[m],s=h[m-1];i=Math.round(s.coords[0]-o.coords[0]),l=Math.round(s.coords[1]-o.coords[1]);var g=[0,0];if(m===h.length-1&&(0==i||0==l?(i>0&&(g=[-n/(2*a*f),0]),i<0&&(g=[n/(2*a*f),0]),l>0&&(g=[0,-n/(2*a*f)]),l<0&&(g=[0,n/(2*a*f)])):(i>0&&l>0&&(g=[-n/(2*a*f*u),-n/(2*a*f*u)]),i>0&&l<0&&(g=[-n/(2*a*f*u),n/(2*a*f*u)]),i<0&&l>0&&(g=[n/(2*a*f*u),-n/(2*a*f*u)]),i<0&&l<0&&(g=[n/(2*a*f*u),n/(2*a*f*u)]))),c=[[e(s.coords[0]+p[0]),r(s.coords[1]+p[1])],[e(o.coords[0]+p[0]+g[0]),r(o.coords[1]+p[1]+g[1])]],0==i||0==l)b="udlr",d+="L"+c[1][0]+","+c[1][1];else if(Math.abs(i)==Math.abs(l)&&Math.abs(i)>1)b="diagonal",d+="L"+c[1][0]+","+c[1][1];else if(1==Math.abs(i)&&1==Math.abs(l))switch(o.dir.toLowerCase()){case"e":d+="Q"+c[1][0]+","+c[0][1]+","+c[1][0]+","+c[1][1];break;case"s":case"n":d+="Q"+c[0][0]+","+c[1][1]+","+c[1][0]+","+c[1][1];break;case"w":d+="Q"+c[1][0]+","+c[0][1]+","+c[1][0]+","+c[1][1]}else if(1==Math.abs(i)&&2==Math.abs(l)||2==Math.abs(i)&&1==Math.abs(l)){var y;1==i||-1==i?"udlr"==b?y=[c[0][0],c[0][1]+(c[1][1]-c[0][1])/2]:"diagonal"==b&&(y=[c[1][0],c[0][1]+(c[1][1]-c[0][1])/2]):(-2==i||2==i)&&("udlr"==b?y=[c[0][0]+(c[1][0]-c[0][0])/2,c[0][1]]:"diagonal"==b&&(y=[c[0][0]+(c[1][0]-c[0][0])/2,c[1][1]])),d+="C"+y[0]+","+y[1]+","+y[0]+","+y[1]+","+c[1][0]+","+c[1][1]}}else{o=h[m+1],s=h[m],i=Math.round(s.coords[0]-o.coords[0]),l=Math.round(s.coords[1]-o.coords[1]);var k=[0,0];0==i||0==l?(i>0&&(k=[n/(2*a*f),0]),i<0&&(k=[-n/(2*a*f),0]),l>0&&(k=[0,n/(2*a*f)]),l<0&&(k=[0,-n/(2*a*f)])):(i>0&&l>0&&(k=[n/(2*a*f*u),n/(2*a*f*u)]),i>0&&l<0&&(k=[n/(2*a*f*u),-n/(2*a*f*u)]),i<0&&l>0&&(k=[-n/(2*a*f*u),n/(2*a*f*u)]),i<0&&l<0&&(k=[-n/(2*a*f*u),-n/(2*a*f*u)])),d+="M"+(c=[e(s.coords[0]+p[0]+k[0]),r(s.coords[1]+p[1]+k[1])])[0]+","+c[1]}return d}function n(t){this.lines=t}function a(t){this.stations=t}a.prototype.toArray=function(){var t=[];for(var e in this.stations)if(this.stations.hasOwnProperty(e)){var r=this.stations[e];r.name=e,t.push(r)}return t},a.prototype.interchanges=function(){return this.toArray().filter((function(t){return"interchange"===t.marker[0].marker}))},a.prototype.normalStations=function(){var t=this.toArray().filter((function(t){return"interchange"!==t.marker[0].marker})),e=[];return t.forEach((function(t){t.marker.forEach((function(r){e.push({name:t.name,line:r.line,x:t.x,y:t.y,color:r.color,shiftX:r.shiftX,shiftY:r.shiftY,labelPos:t.labelPos})}))})),e},t.tubeMap=function(){var t,o,s,i,l={top:80,right:80,bottom:20,left:80},c=760,d=640,h=e.scaleLinear(),f=e.scaleLinear(),u=e.dispatch("click");function p(n){n.each((function(a){s=function(t){return{raw:t.lines,river:t.river,stations:b(t),lines:m(t.lines)}}(a);var p,k,w=e.min(s.raw,(function(t){return e.min(t.nodes,(function(t){return t.coords[0]}))}))-1,v=e.max(s.raw,(function(t){return e.max(t.nodes,(function(t){return t.coords[0]}))}))+1,C=e.min(s.raw,(function(t){return e.min(t.nodes,(function(t){return t.coords[1]}))}))-1,x=e.max(s.raw,(function(t){return e.max(t.nodes,(function(t){return t.coords[1]}))}))+1,P=(v-w)/(x-C),M=(c-l.left-l.right)/(d-l.top-l.bottom),O=M/P;P>M?(p=c-l.left-l.right,k=(d-l.top-l.bottom)*O):(p=(c-l.left-l.right)/O,k=d-l.top-l.bottom),h.domain([w,v]).range([l.left,l.left+p]),f.domain([C,x]).range([l.top+k,l.top]);var S=Math.abs(h(1)-h(0)!=0?h(1)-h(0):f(1)-f(0));t=.8*S,o=n.append("svg").style("width","100%").style("height","100%"),i=o.append("g"),void 0!==s.river&&i.append("g").attr("class","river").selectAll("path").data([s.river]).enter().append("path").attr("d",(function(e){return r(e,h,f,t,1.5)})).attr("stroke","#CCECF4").attr("fill","none").attr("stroke-width",1.8*t),i.append("g").attr("class","lines").selectAll("path").data(s.lines.lines).enter().append("path").attr("d",(function(e){return r(e,h,f,t,1.5)})).attr("id",(function(t){return t.name})).attr("stroke",(function(t){return t.color})).attr("fill","none").attr("stroke-width",(function(e){return e.highlighted?1.3*t:t})).classed("line",!0),i.append("g").attr("class","interchanges").selectAll("path").data(s.stations.interchanges()).enter().append("g").attr("id",(function(t){return t.name})).on("click",(function(){var t=e.select(this).attr("id");u.call("click",this,t)})).append("path").attr("d",function(t){return e.arc().innerRadius(0).outerRadius(1.25*t).startAngle(0).endAngle(2*Math.PI)}(t)).attr("transform",(function(t){return"translate("+h(t.x+.8*t.marker[0].shiftX)+","+f(t.y+.8*t.marker[0].shiftY)+")"})).attr("stroke-width",t/2).attr("fill",(function(t){return t.visited?"#000000":"#ffffff"})).attr("stroke",(function(t){return t.visited?"#ffffff":"#000000"})).classed("interchange",!0).style("cursor","pointer"),i.append("g").attr("class","stations").selectAll("path").data(s.stations.normalStations()).enter().append("g").attr("id",(function(t){return t.name})).on("click",(function(){var t=e.select(this).attr("id");u.call("click",this,t)})).append("path").attr("d",(function(t){return function(t,r,n,a,o){var s,i=Math.sqrt(2),l=e.line().x((function(t){return r(t[0])})).y((function(t){return n(t[1])}));switch(t.labelPos.toLowerCase()){case"n":s=[0,1];break;case"ne":s=[1/i,1/i];break;case"e":s=[1,0];break;case"se":s=[1/i,-1/i];break;case"s":s=[0,-1];break;case"sw":s=[-1/i,-1/i];break;case"w":s=[-1,0];break;case"nw":s=[-1/i,1/i]}return l([[t.x+t.shiftX*a+a/2.05*s[0],t.y+t.shiftY*a+a/2.05*s[1]],[t.x+t.shiftX*a+a/2*s[0]+a/o*s[0],t.y+t.shiftY*a+a/2*s[1]+a/o*s[1]]])}(t,h,f,.8,1.5)})).attr("stroke",(function(t){return t.color})).attr("stroke-width",t/1.5).attr("fill","none").attr("class",(function(t){return t.line})).attr("id",(function(t){return t.name})).classed("station",!0),i.append("g").attr("class","labels").selectAll("text").data(s.stations.toArray()).enter().append("g").attr("id",(function(t){return t.name})).classed("label",!0).on("click",(function(){var t=e.select(this).attr("id");u.call("click",this,t)})).append("text").text((function(t){return t.label})).attr("fill","#10137E").attr("dy",0).attr("x",(function(t){return h(t.x+t.labelShiftX)+g(t).pos[0]})).attr("y",(function(t){return f(t.y+t.labelShiftY)-g(t).pos[1]})).attr("text-anchor",(function(t){return g(t).textAnchor})).style("display",(function(t){return!0!==t.hide?"block":"none"})).style("text-decoration",(function(t){return t.closed?"line-through":"none"})).style("font-size",1.96*t+"px").style("-webkit-user-select","none").attr("class",(function(t){return t.marker.map((function(t){return t.line})).join(" ")})).classed("highlighted",(function(t){return t.visited})).call(y,(function(t){return g(t).alignmentBaseline}))}))}function b(t){return t.lines.forEach((function(e){for(var r=0;r<e.nodes.length;r++){var n=e.nodes[r];if(n.hasOwnProperty("name")){if(!t.stations.hasOwnProperty(n.name))throw new Error("Cannot find station with key: "+n.name);var a=t.stations[n.name];a.x=n.coords[0],a.y=n.coords[1],void 0===a.labelPos&&(a.labelPos=n.labelPos,a.labelShiftX=n.hasOwnProperty("labelShiftCoords")?n.labelShiftCoords[0]:n.hasOwnProperty("shiftCoords")?n.shiftCoords[0]:e.shiftCoords[0],a.labelShiftY=n.hasOwnProperty("labelShiftCoords")?n.labelShiftCoords[1]:n.hasOwnProperty("shiftCoords")?n.shiftCoords[1]:e.shiftCoords[1]),n.hasOwnProperty("canonical")&&(a.labelPos=n.labelPos,a.labelShiftX=n.hasOwnProperty("labelShiftCoords")?n.labelShiftCoords[0]:n.hasOwnProperty("shiftCoords")?n.shiftCoords[0]:e.shiftCoords[0],a.labelShiftY=n.hasOwnProperty("labelShiftCoords")?n.labelShiftCoords[1]:n.hasOwnProperty("shiftCoords")?n.shiftCoords[1]:e.shiftCoords[1]),a.label=t.stations[n.name].label,a.position=t.stations[n.name].position,a.closed=!!t.stations[n.name].hasOwnProperty("closed")&&t.stations[n.name].closed,a.visited=!1,n.hide||(a.marker=a.marker||[],a.marker.push({line:e.name,color:e.color,labelPos:n.labelPos,marker:n.hasOwnProperty("marker")?n.marker:"station",shiftX:n.hasOwnProperty("shiftCoords")?n.shiftCoords[0]:e.shiftCoords[0],shiftY:n.hasOwnProperty("shiftCoords")?n.shiftCoords[1]:e.shiftCoords[1]}))}}})),new a(t.stations)}function m(t){var e=[];return t.forEach((function(t){var r={name:t.name,title:t.label,stations:[],color:t.color,shiftCoords:t.shiftCoords,nodes:t.nodes,highlighted:!1};e.push(r);for(var n=0;n<t.nodes.length;n++){var a=t.nodes[n];a.hasOwnProperty("name")&&r.stations.push(a.name)}})),function(t){return new n(t)}(e)}function g(e){var r,n,a,o=1.8*t,s=e.label.split(/\n/).length,i=Math.sqrt(2);switch(e.labelPos.toLowerCase()){case"n":r=[0,2.1*t*(s-1)+o],n="middle",a="baseline";break;case"ne":r=[o/i,(t*(s-1)+o)/i],n="start",a="baseline";break;case"e":r=[o,0],n="start",a="middle";break;case"se":r=[o/i,-o/i],n="start",a="hanging";break;case"s":r=[0,-.8*o],n="middle",a="hanging";break;case"sw":r=[-o/i,-o/i],n="end",a="hanging";break;case"w":r=[-o,0],n="end",a="middle";break;case"nw":r=[-(t*(s-1)+o)/i,(t*(s-1)+o)/i],n="end",a="baseline"}return{pos:r,textAnchor:n,alignmentBaseline:a}}function y(t,r){t.each((function(){var t=e.select(this),n=t.text().split(/\n/),a=t.attr("y"),o=t.attr("x"),s=parseFloat(t.attr("dy"));t.text(null).append("tspan").attr("x",o).attr("y",a).attr("dy",s+"em").attr("dominant-baseline",r).text(n[0]);for(var i=1;i<n.length;i++)t.append("tspan").attr("x",o).attr("y",a).attr("dy",1.1*i+s+"em").attr("dominant-baseline",r).text(n[i])}))}return p.width=function(t){return arguments.length?(c=t,p):c},p.height=function(t){return arguments.length?(d=t,p):d},p.margin=function(t){return arguments.length?(l=t,p):l},p.on=function(){var t=u.on.apply(u,arguments);return t===u?p:t},p},Object.defineProperty(t,"__esModule",{value:!0})}));
